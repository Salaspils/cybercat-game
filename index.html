<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CyberCat v58.0: Final Stable</title>
    <script src="three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #d0d9d9; font-family: 'Segoe UI', sans-serif; }
        #ui { position: fixed; top: 20px; left: 20px; z-index: 100; pointer-events: none; }
        .hud { background: rgba(0,0,0,0.6); border-left: 4px solid #ffcc00; padding: 15px; border-radius: 4px; color: #fff; backdrop-filter: blur(15px); }
        .btns { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: auto; }
        .btn { background: #3d2b1f; color: #ffcc00; border: 1px solid #ffcc00; padding: 12px 25px; cursor: pointer; font-weight: bold; text-transform: uppercase; border-radius: 4px; }
        #clock { font-size: 28px; font-weight: 900; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="hud">
            <div id="clock">06:00</div>
            <div style="color: #00ffcc; font-size: 14px;">$MEOW: <b id="bal">0</b></div>
            <div style="font-size: 9px; opacity: 0.6; margin-top: 5px;">STABLE_PHOTOREAL_v58</div>
        </div>
    </div>
    <div class="btns">
        <button class="btn" onclick="db.board = !db.board">УСКОРЕНИЕ</button>
        <button class="btn" onclick="buildShed()">СТРОИТЬ СРУБ (900)</button>
        <button class="btn" onclick="plantGarden()">ОГОРОД (150)</button>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('cyber_v58')) || { bal: 1000, builds: [], gardens: [], time: 1.6, board: false };

        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xd0d9d9, 0.007);
        scene.background = new THREE.Color(0xd0d9d9);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 4000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1.2;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // СВЕТ: РАССВЕТ
        const sun = new THREE.DirectionalLight(0xffe4b5, 2.5);
        sun.position.set(300, 150, -500); sun.castShadow = true;
        sun.shadow.mapSize.set(2048, 2048); scene.add(sun);
        scene.add(new THREE.HemisphereLight(0x87ceeb, 0x3d2b1f, 0.6));

        // ЗЕМЛЯ И ВОДА
        const bank = new THREE.Mesh(new THREE.PlaneGeometry(1500, 3000), new THREE.MeshStandardMaterial({ color: 0x3d4d2b, roughness: 1 }));
        bank.rotation.x = -Math.PI/2; bank.position.set(-750, -1, 0); bank.receiveShadow = true; scene.add(bank);
        const water = new THREE.Mesh(new THREE.PlaneGeometry(3000, 3000), new THREE.MeshStandardMaterial({ color: 0x1a3c40, metalness: 0.9, roughness: 0.1 }));
        water.rotation.x = -Math.PI/2; water.position.set(1500, -1.3, 0); scene.add(water);

        // ПЕРСОНАЖ: КОТ (ИСПРАВЛЕННЫЙ)
        const cat = new THREE.Group();
        const catMat = new THREE.MeshStandardMaterial({color: 0x222222, roughness: 0.7});
        const cBody = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 2.5, 12), catMat);
        cBody.rotation.z = Math.PI/2; cBody.position.y = 0.8; cBody.castShadow = true; cat.add(cBody);
        const cHead = new THREE.Mesh(new THREE.SphereGeometry(0.8, 16, 16), catMat);
        cHead.position.set(1.4, 1.5, 0); cat.add(cHead);
        scene.add(cat);
        let target = new THREE.Vector3(0, 0, 0);

        // ПОСТРОЙКИ
        function createShed(pos) {
            const g = new THREE.Group();
            const logMat = new THREE.MeshStandardMaterial({ color: 0x4d3020, roughness: 1 });
            for(let i=0; i<7; i++) {
                const log = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 14, 12), logMat);
                log.rotation.z = Math.PI/2; log.position.y = i * 1.1; 
                log.rotation.y = (i % 2) * Math.PI/2;
                log.castShadow = true; log.receiveShadow = true; g.add(log);
            }
            g.position.set(pos.x, 0.5, pos.z); scene.add(g);
        }
        db.builds.forEach(p => createShed(p));

        window.buildShed = () => {
            if(db.bal >= 900) {
                db.bal -= 900; const p = {x: cat.position.x, z: cat.position.z};
                db.builds.push(p); createShed(p); save();
            }
        };

        function createGarden(pos) {
            const bed = new THREE.Mesh(new THREE.BoxGeometry(7, 0.2, 10), new THREE.MeshStandardMaterial({ color: 0x1a0f00 }));
            bed.position.set(pos.x, 0.1, pos.z); bed.receiveShadow = true; scene.add(bed);
        }
        db.gardens.forEach(g => createGarden(g));

        window.plantGarden = () => {
            if(db.bal >= 150) {
                db.bal -= 150; const p = {x: cat.position.x + 10, z: cat.position.z};
                db.gardens.push(p); createGarden(p); save();
            }
        };

        window.addEventListener('pointerdown', (e) => {
            const ray = new THREE.Raycaster();
            const m = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
            ray.setFromCamera(m, camera);
            const hit = new THREE.Vector3();
            if(ray.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0,1,0), 0), hit)) target.copy(hit);
        });

        function save() {
            localStorage.setItem('cyber_v58', JSON.stringify(db));
            document.getElementById('bal').innerText = Math.floor(db.bal);
        }

        function animate() {
            requestAnimationFrame(animate);
            db.time += 0.00004; 
            let h = Math.floor(((db.time % (Math.PI*2)) / (Math.PI*2)) * 24);
            document.getElementById('clock').innerText = h.toString().padStart(2, '0') + ":00";

            cat.position.lerp(target, db.board ? 0.3 : 0.08);
            if(cat.position.distanceTo(target) > 1) cat.lookAt(target.x, 0, target.z);

            camera.position.lerp(new THREE.Vector3(cat.position.x - 60, 20, cat.position.z + 70), 0.03);
            camera.lookAt(cat.position);
            renderer.render(scene, camera);
            save();
        }
        save(); animate();
    </script>
</body>
</html>
