<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CyberCat v61.0: Real Farm Sim</title>
    <script src="three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87ceeb; font-family: 'Segoe UI', sans-serif; }
        #ui { position: fixed; top: 20px; left: 20px; z-index: 100; pointer-events: none; }
        .hud { background: rgba(0,0,0,0.5); border-radius: 8px; padding: 20px; color: #fff; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .btns { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: auto; }
        .btn { background: #3d4d2b; color: #fff; border: none; padding: 12px 30px; cursor: pointer; font-weight: bold; border-radius: 4px; text-transform: uppercase; transition: 0.3s; box-shadow: 0 4px 0 #2d3e1f; }
        .btn:hover { background: #4d5d3b; transform: translateY(-2px); }
        #clock { font-size: 28px; font-weight: 900; color: #ffcc00; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="hud">
            <div id="clock">10:00</div>
            <div style="font-size: 14px; margin-bottom: 5px;">БАЛАНС: <b id="bal" style="color:#00ffcc;">1000</b></div>
            <div style="font-size: 9px; opacity: 0.6; letter-spacing: 1px;">ENGINE: FARM_SIM_ULTRA_v61</div>
        </div>
    </div>
    <div class="btns">
        <button class="btn" onclick="db.board = !db.board">УСКОРЕНИЕ</button>
        <button class="btn" onclick="buildHouse()">ПОСТРОИТЬ СРУБ</button>
        <button class="btn" onclick="plantGarden()">ОГОРОД</button>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('cyber_v61')) || { bal: 1000, builds: [], gardens: [], time: 1.5, board: false };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xaaccff);
        scene.fog = new THREE.FogExp2(0xaaccff, 0.0015);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 5000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping; // Кинематографичный вид
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // СВЕТ: РЕАЛИСТИЧНОЕ СОЛНЦЕ
        const sun = new THREE.DirectionalLight(0xfff0dd, 1.8);
        sun.position.set(300, 500, 100);
        sun.castShadow = true;
        sun.shadow.mapSize.set(4096, 4096);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xccddee, 0.7));

        // ЗЕМЛЯ И ГУСТАЯ ТРАВА (Instanced)
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(3000, 3000), new THREE.MeshStandardMaterial({ color: 0x2d3e1f, roughness: 1 }));
        ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

        const grassCount = 15000;
        const grassGeo = new THREE.PlaneGeometry(0.5, 2.5);
        const grassMat = new THREE.MeshStandardMaterial({ color: 0x4d5d3b, side: 2, alphaTest: 0.5 });
        const instancedGrass = new THREE.InstancedMesh(grassGeo, grassMat, grassCount);
        const dummy = new THREE.Object3D();
        for(let i=0; i<grassCount; i++) {
            dummy.position.set((Math.random()-0.5)*800, 1.25, (Math.random()-0.5)*800);
            dummy.rotation.y = Math.random()*Math.PI;
            dummy.updateMatrix();
            instancedGrass.setMatrixAt(i, dummy.matrix);
        }
        scene.add(instancedGrass);

        // ГЛАВНЫЙ ГЕРОЙ: КОТ (Улучшенный)
        const cat = new THREE.Group();
        const catMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.8 });
        const cBody = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1, 3, 16), catMat);
        cBody.rotation.z = Math.PI/2; cBody.position.y = 1.2; cBody.castShadow = true; cat.add(cBody);
        
        const cHead = new THREE.Mesh(new THREE.SphereGeometry(0.9, 16, 16), catMat);
        cHead.position.set(1.8, 2, 0); cat.add(cHead);
        
        const ears = new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.6, 4), catMat);
        ears.position.set(1.8, 2.8, 0.4); cat.add(ears.clone());
        ears.position.z = -0.4; cat.add(ears);
        
        scene.add(cat);
        let target = new THREE.Vector3(0, 0, 0);

        // ПОСТРОЙКИ (FS-Style Logs)
        function createShed(pos) {
            const shed = new THREE.Group();
            const logMat = new THREE.MeshStandardMaterial({ color: 0x3d2b1f, roughness: 0.9, metalness: 0.1 });
            for(let i=0; i<9; i++) {
                const log = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 16, 12), logMat);
                log.rotation.z = Math.PI/2; log.position.y = i * 1.2; log.rotation.y = (i%2)*Math.PI/2;
                log.castShadow = true; log.receiveShadow = true; shed.add(log);
            }
            shed.position.set(pos.x, 0.5, pos.z);
            scene.add(shed);
        }
        db.builds.forEach(p => createShed(p));

        window.buildHouse = () => {
            if(db.bal >= 900) {
                db.bal -= 900; const p = {x: cat.position.x, z: cat.position.z};
                db.builds.push(p); createShed(p); save();
            }
        };

        window.addEventListener('pointerdown', (e) => {
            const ray = new THREE.Raycaster();
            const m = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
            ray.setFromCamera(m, camera);
            const hit = new THREE.Vector3();
            if(ray.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0,1,0), 0), hit)) target.copy(hit);
        });

        function save() {
            localStorage.setItem('cyber_v61', JSON.stringify(db));
            document.getElementById('bal').innerText = Math.floor(db.bal);
        }

        function animate() {
            requestAnimationFrame(animate);
            db.time += 0.00004;
            let h = Math.floor(((db.time % (Math.PI*2)) / (Math.PI*2)) * 24);
            document.getElementById('clock').innerText = h.toString().padStart(2, '0') + ":00";

            cat.position.lerp(target, db.board ? 0.25 : 0.07);
            if(cat.position.distanceTo(target) > 1.5) cat.lookAt(target.x, cat.position.y, target.z);

            // Камера: Плавное следование (Simulator Style)
            const camPos = new THREE.Vector3(cat.position.x - 80, 45, cat.position.z + 90);
            camera.position.lerp(camPos, 0.04);
            camera.lookAt(cat.position.x, 8, cat.position.z);

            renderer.render(scene, camera);
            save();
        }
        save(); animate();
    </script>
</body>
</html>
